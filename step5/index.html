<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdn.bootcss.com/babel-standalone/7.0.0-beta.2/babel.min.js"></script>
    <title>Document</title>
    <style>
        .my-test-class{
            width: 100px;
            height: 100px;
            background-color: red;
            display: block;
        }
    </style>
</head>
<body>
    <div id='app'></div>
</body>
</html>
<script type="text/babel">
    var tagMap = {"a":"a","abbr":"abbr","address":"address","area":"area","article":"article","aside":"aside","audio":"audio","b":"b","base":"base","bdi":"bdi","bdo":"bdo","big":"big","blockquote":"blockquote","body":"body","br":"br","button":"button","canvas":"canvas","caption":"caption","cite":"cite","code":"code","col":"col","colgroup":"colgroup","data":"data","datalist":"datalist","dd":"dd","del":"del","details":"details","dfn":"dfn","dialog":"dialog","div":"div","dl":"dl","dt":"dt","em":"em","embed":"embed","fieldset":"fieldset","figcaption":"figcaption","figure":"figure","footer":"footer","form":"form","h1":"h1","h2":"h2","h3":"h3","h4":"h4","h5":"h5","h6":"h6","head":"head","header":"header","hgroup":"hgroup","hr":"hr","html":"html","i":"i","iframe":"iframe","img":"img","input":"input","ins":"ins","kbd":"kbd","keygen":"keygen","label":"label","legend":"legend","li":"li","link":"link","main":"main","map":"map","mark":"mark","menu":"menu","menuitem":"menuitem","meta":"meta","meter":"meter","nav":"nav","noscript":"noscript","object":"object","ol":"ol","optgroup":"optgroup","option":"option","output":"output","p":"p","param":"param","picture":"picture","pre":"pre","progress":"progress","q":"q","rp":"rp","rt":"rt","ruby":"ruby","s":"s","samp":"samp","script":"script","section":"section","select":"select","small":"small","source":"source","span":"span","strong":"strong","style":"style","sub":"sub","summary":"summary","sup":"sup","table":"table","tbody":"tbody","td":"td","textarea":"textarea","tfoot":"tfoot","th":"th","thead":"thead","time":"time","title":"title","tr":"tr","track":"track","u":"u","ul":"ul","var":"var","video":"video","wbr":"wbr","circle":"circle","clipPath":"clipPath","defs":"defs","ellipse":"ellipse","g":"g","image":"image","line":"line","linearGradient":"linearGradient","mask":"mask","path":"path","pattern":"pattern","polygon":"polygon","polyline":"polyline","radialGradient":"radialGradient","rect":"rect","stop":"stop","svg":"svg","text":"text","tspan":"tspan"}
    //更新模块队列
    var updateQueue = {
        updaters:[],
        isPending:false,
        addUpdater:function(updater){
            this.updaters.push(updater);
        },
        batchUpdate:function(){
            this.isPending = true;
            var updater = null;
            while (updater = this.updaters.pop()) {
                updater.updateComponent();
            }
            this.isPending = false;
        }
    };

    //单个更新模块
    function Updater (component){
        this.component = component
        this.isPending = false;
        this.pendingStates = [];
        this.state = {};
    }

    Updater.prototype.updateComponent = function(){
        this.component.shouldUpdate(this.getState());
    }
    Updater.prototype.addState = function(state){
        this.pendingStates.push(state);
        this.doUpdate();
    }
    Updater.prototype.getState = function(){
        var state = Object.assign({},this.component.state);
        for(var i =0,l=this.pendingStates.length;i<l;i++){
            var newState = this.pendingStates[i];
            state = Object.assign({},state,newState);
        }
        return state;
    }
    Updater.prototype.doUpdate = function(){
        updateQueue.isPending?updateQueue.addUpdater(this):this.updateComponent()
    }

    function Component(props){
        this.updater = new Updater(this);
        this.state = {};
        this.props = {};
    }

    Component.prototype = {
        isReactComponent:true,
        update:function(){
            //如果正在更新中，把state加入到updater，等下一回更新
            if(this.updater.isPending){
                this.updater.addState();
                return;
            }
            var newVnode = createComponent(this);
            
        },
        shouldUpdate:function(nextState){
            var update = true;
            if(this.shouldComponentUpdate){
                update = this.shouldComponentUpdate(nextProps, nextState);
            }
            if(update === false){
                return;
            }
            this.state = nextState;
            this.update()
        },
        setState:function(newState){
            this.updater.addState(newState)
        }
    }

    var React = {
        createElement:createElement,
        createClass:createClass,
        render:render
    }

    function createClass(options){
        if(!options.render){
            throw new Error('render of class must be a function');
        }
        function Klass(props){
            this.props = props;
        }
        Klass.prototype = new Component();
        for(var k in options){
            Klass.prototype[k] = options[k];
        }
        return Klass;
    }

    function createElement(type,props,children){
        console.log(typeof type);
        var vtype = null;
        if(typeof type === 'string'){
            vtype = 'htmlel';
        }else if(typeof type === 'function'){
            vtype = 'component';
        }else{
            throw new Error('unknow type of element');
        }

        var componentProps = {};
        if(props){
            for(var k in props){
                componentProps[k] = props[k];
            };
        }

        // if(children){
        //     componentProps.children = children;
        // }
        //修复多个子元素的问题
        //改为如下
        
        if(arguments.length>3){//多个子元素，至少一个子元素的时候，算上type跟props，至少为3个参数
            var componentChildren = [];
            for(var i= 2,l=arguments.length;i<l;i++){
                componentChildren[i-2] = arguments[i];
            }
            componentProps.children = componentChildren;
        }else{
            componentProps.children = children;
        }

        var vnode = createVnodeModal(vtype,type,componentProps);
        return vnode;
    }

    function createVnodeModal(vtype,type,props){
        var vnode = {
            vtype:vtype,
            type:type,
            props:props
        }

        return vnode;
    }

    function createvnode2el(vnode){
        var vtype = vnode.vtype,
            type = vnode.type,
            props = vnode.props;
        var dom = null;
        if(!vtype || vtype === 'htmlel'){//无论何种创建，最后都会到这步判断，生成html标签
            dom = createHtmlEl(vnode);
        }else{
            var component = new type(props);
            dom = createComponent(component)
        }
        return dom;
    }

    function createHtmlEl(vnode){
        var type = vnode.type,
            props = vnode.props,
            dom = null;
        if(tagMap[type]){
            dom = document.createElement(type);
        }else{
            dom = document.createTextNode(vnode);
        }
        setProps(dom,props);
        return dom;
    }

    //在component内update的时候，component为构造函数，跟type一样
    //所以需要拆分，type为构造函数，放到上一层createvnode2el去new
    function createComponent(component){
            vnode = component.render();
        var dom = createvnode2el(vnode);
        return dom;
    }

    var EVENT_KEYS = /^on/i;  //判断是否为事件
    function setProps(el,props){
        for(var attributeName in props){
            var value = props[attributeName];
            if(EVENT_KEYS.test(attributeName)){
                addEvent(el,attributeName,value);
            }else if(attributeName === 'children'){
                createChildrenNode(value,el);
            }else{
                el.setAttribute(attributeName,value);
            }
        }
    }

    function createChildrenNode(children,parentNode){
        if(!(children instanceof Array)){
            children = [children];
        }
        for(var i=0,l=children.length;i<l;i++){
            var child = children[i];
            parentNode.appendChild(createvnode2el(child));
        }
    }


    var bindedEventMap={};
    function addEvent(el,eventName,fn){
        eventName = eventName.toLowerCase().replace(/^on/,'');
        el.eventMap = el.eventMap || (el.eventMap = {});
        el.eventMap[eventName] = fn;
        if(!bindedEventMap[eventName]){
            document.addEventListener(eventName, dispatchEvent,false);
            bindedEventMap[eventName] = true;
        }
    }

    function dispatchEvent(e){
        var target = e.target,
            type = e.type;
        updateQueue.isPending = true
        var diyEvent;
        while(target){
            var eventMap = target.eventMap,
                fn = eventMap && eventMap[type];
            
            if(!diyEvent){
                diyEvent = createDiyEvent(e)
            }
            if(!fn){
                target = target.parentNode;
                continue;
            }
            //e为自定义事件对象X，并且赋值其stopPropagation为()=>X.cancelBubble=true
            //所以，当设置e.stopPropagation()的时候，其实设置该对象X的cancelBubble为true;
            
            fn.call(target,e);
            //判断X。cancelBubble是否为true。是break出循环
            //由于一处阻止了冒泡，所以这一次的事件冒泡阶段全部结束。
            //除非再次dispatchEvent。那么X将被重新定义
            target = target.parentNode;
        }
        updateQueue.isPending = false
        updateQueue.batchUpdate();
    }

    function createDiyEvent(e){
        var diyEvent = {};
        const cancelBubble = ()=>diyEvent.cancelBuddle = true;
        diyEvent.nativeEvent = e;
        for(var k in e){
            if(typeof e[k] !== "function"){
                diyEvent[k] = e[k]
            }else if(k === "stopPropagation" || k === "stopImmediatePropagation"){
                diyEvent[k] = cancelBubble;
            }else{
                diyEvent[k] = e[k].bind(e);
            }
        }

        return diyEvent;
    }



    function render(vnode,container){
        var node = createvnode2el(vnode);
        container.appendChild(node);
    }

    //test demo
    var TestCls = React.createClass({
        getInitialState:function(params) {
            return {
                name:123
            }
        },
        onclick:function(){
            this.setState({
                name:1111
            })
        },
        render:function(){
            return (
                <div className="test" onClick={()=>this.onclick()}>
                    <ChildCls/>
                </div>
            )
        }
    })

    var ChildCls = React.createClass({
        render:function(){
            return (<div className="children" onClick={this.props.clickEvent}>
                    <a className="child1" >child child</a>
                    <a className="child2">child2 child2</a>
                    </div>)
        }
    })

    React.render(
        <TestCls/>,
        document.getElementById('app')
    )
</script>